#include "Function.h"
#include "State.h"
CLASS(SampleNewton, "Newton's Method") { public:
  complex a;
  int depth;
  double escape;

  SampleNewton(String name, String label, int pspace) : Function(name, label, pspace) {
    PARAM(a, "a", complex, complex(0.5, 0.866025), complex(0.5, 0.866025));
    PARAM(depth, "depth", int, 50, 50);
    PARAM(escape, "bound", double, 1000, 1000);
    setDefaultRangeParameterSpace(-1, 2, 0, 3);
    setDefaultRangeDynamicalSpace(-0.8, 1.8, -1.04, 1.56);
  }

  Function *copy() {
    SampleNewton *f = new SampleNewton(name, "", pspace);
    return f->copyArgsFrom(this);
  }

  double iterate_(double x, double y) {
    int i;
    complex z;
    if (PARAMETER_SPACE) {
      a.set(x, y);
      z = (1.0+a)/3.0;
    } else {
      a.set(0.5, 0.866025);
      z = complex(x, y);
    }
    for (i = 0; i < depth; i++) {
      z = z*z*(1+a-2*z)/(-a+2*z+2*a*z-3*z*z);
      if (norm(z-a)<(1/escape)||norm(z-1)<(1/escape)||norm(z)<(1/escape))
        return (double)i/depth;
    }
    return 1.0;
  }

  void orbit(complex &z) {
    z = z*z*(1+a-2*z)/(-a+2*z+2*a*z-3*z*z);
  }

  void setParameter(double x, double y) {
    a.set(x, y);
  }
};

///////////////////////////////////////////////////////////////////////////////
