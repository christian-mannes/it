#include "Function.h"
#include "State.h"

CLASS(SampleMilnor, "Milnor function") { public:
  // Declare your parameters and working variables here
  complex a;
  int depth;
  double escape;

  SampleMilnor(String name, String label, int pspace) : Function(name, label, pspace) {
    // List every parameter you want to appear in the "parameters" section
    // using ARG(variable, parameter-name, default-value, allowed-values)
    PARAM(a, "a", complex, complex(1, 0), complex(-1,0));
    PARAM(depth, "depth", int, 75, 75);
    PARAM(escape, "bound", double, 1000, 1000);
    // Set the default range for both spaces
    setDefaultRangeParameterSpace(-9, 6, -7.5, 7.5);
    setDefaultRangeDynamicalSpace(-2, 2, -2, 2);
  }

  Function *copy() {
    SampleMilnor *f = new SampleMilnor(name, "", pspace);
    return f->copyArgsFrom(this);
  }

  double iterate_(double x, double y) {
    int i;
    complex z;
    if (PARAMETER_SPACE) {
      a.set(x, y);
      z = 2.0/3.0;
    } else {
      a.set(1, 0); /// Nuria?
      z = complex(x, y);
    }
    for (i = 0; i < depth; i++) {
      z = a * z * z * (z - 1);
      if (norm(z) < 1/(escape*escape)) return 0.9;
      if (norm(z) > escape * escape) break;
    }
    return (double)i/depth;
  }

  // Forward orbit: assign f(x) to x
  void orbit(complex &x) {
    x = a * x * x * (x - 1);
  }

  // Set the parameter in dynamical space
  void setParameter(double x, double y) {
    a.set(x, y);
  }
};

///////////////////////////////////////////////////////////////////////////////
